<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini 3 Prompt Composer</title>
    <!-- Vue 3 & Tailwind CSS -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Segoe UI', Roboto, Helvetica, sans-serif; background-color: #0b1120; color: #e2e8f0; }
        .glass { background: rgba(30, 41, 59, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(148, 163, 184, 0.1); }
        .glass-input { background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(51, 65, 85, 0.5); }
        textarea { field-sizing: content; min-height: 80px; }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        a { color: #60a5fa; text-decoration: none; }
        a:hover { text-decoration: underline; }
        
        /* Dropdown transition */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
    </style>
</head>
<body>

<div id="app" class="min-h-screen p-4 lg:p-8 flex flex-col lg:flex-row gap-8 max-w-[1800px] mx-auto">
    
    <!-- Left Column: Construction Area -->
    <div class="w-full lg:w-3/5 flex flex-col gap-5">
        <header class="mb-2 flex justify-between items-end">
            <div>
                <h1 class="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-emerald-400 tracking-tight">
                    <i class="fa-solid fa-layer-group mr-2"></i>Gemini 3 Prompt Composer
                </h1>
                <p class="text-slate-500 text-sm font-medium mt-1">{{ t('appSubtitle') }}</p>
            </div>
            <!-- Language Selector -->
            <select v-model="currentLang" class="bg-slate-900 text-slate-400 text-xs py-1 px-3 rounded border border-slate-700 outline-none hover:border-blue-500 transition">
                <option value="en">English (Default)</option>
                <option value="zh">ç¹é«”ä¸­æ–‡ (Taiwan)</option>
                <option value="ja">æ—¥æœ¬èª</option>
            </select>
        </header>

        <!-- API Settings (Region Unchanged as requested) -->
        <div class="glass p-5 rounded-xl flex flex-col gap-4 shadow-lg shadow-black/20">
            <div class="flex items-center gap-3">
                <div class="bg-yellow-500/10 p-2 rounded text-yellow-500"><i class="fa-solid fa-key"></i></div>
                <input v-model="apiKey" type="password" :placeholder="t('apiKeyPlaceholder')" class="glass-input flex-1 outline-none text-sm text-slate-200 placeholder-slate-600 px-3 py-2 rounded focus:border-yellow-500/50 transition">
                <button @click="saveKey" class="text-xs bg-slate-800 hover:bg-slate-700 border border-slate-700 px-4 py-2 rounded font-medium transition">{{ t('saveKey') }}</button>
            </div>
            
            <div class="flex items-center gap-3 pl-11">
                <span class="text-xs text-blue-400 font-mono">MODEL</span>
                <select v-model="selectedModel" class="glass-input text-slate-300 text-xs py-2 px-3 rounded flex-1 outline-none focus:border-blue-500/50 cursor-pointer">
                    <optgroup :label="t('modelGroupRec')">
                        <option value="Qwen/Qwen2.5-7B-Instruct">Qwen 2.5 7B Instruct (Best Overall)</option>
                        <option value="THUDM/glm-4-9b-chat">GLM-4 9B Chat (Balanced)</option>
                    </optgroup>
                    <optgroup label="ğŸ§  Reasoning & Logic (DeepSeek)">
                        <option value="deepseek-ai/DeepSeek-R1-Distill-Qwen-7B">DeepSeek R1 Distill (CoT Strong)</option>
                    </optgroup>
                    <optgroup label="ğŸ’» Coding Specialized">
                        <option value="Qwen/Qwen2.5-Coder-7B-Instruct">Qwen 2.5 Coder (Best for Code)</option>
                        <option value="internlm/internlm2_5-7b-chat">InternLM 2.5 7B</option>
                    </optgroup>
                    <optgroup :label="t('modelGroupTrans')">
                        <option value="tencent/Hunyuan-MT-7B">Hunyuan MT 7B (Best for Translation)</option>
                    </optgroup>
                    <optgroup :label="t('modelGroupFree')">
                        <option value="01-ai/Yi-1.5-9B-Chat-16K">Yi 1.5 9B Chat (Long Context)</option>
                    </optgroup>
                </select>
            </div>
        </div>

        <!-- Block List -->
        <div class="flex flex-col gap-4">
            <div 
                v-for="(block, index) in blocks" 
                :key="index" 
                class="glass rounded-xl p-1 relative group transition-all duration-300 hover:border-blue-500/30 hover:shadow-lg hover:shadow-blue-500/5"
            >
                <!-- Toolbar -->
                <div class="flex flex-wrap justify-between items-center bg-slate-900/40 p-2 rounded-t-lg border-b border-slate-700/50 gap-2">
                    <div class="flex items-center gap-2">
                        <!-- Movement Controls -->
                        <div class="flex items-center bg-slate-800 rounded border border-slate-700 overflow-hidden">
                            <button @click="moveBlockTop(index)" :disabled="index === 0" title="Move to Top" class="w-7 h-7 flex items-center justify-center text-slate-500 hover:text-blue-400 hover:bg-slate-700 disabled:opacity-20 transition border-r border-slate-700/50"><i class="fa-solid fa-angles-up text-[10px]"></i></button>
                            <button @click="moveBlockUp(index)" :disabled="index === 0" title="Move Up" class="w-7 h-7 flex items-center justify-center text-slate-500 hover:text-blue-400 hover:bg-slate-700 disabled:opacity-20 transition border-r border-slate-700/50"><i class="fa-solid fa-angle-up text-xs"></i></button>
                            <button @click="moveBlockDown(index)" :disabled="index === blocks.length - 1" title="Move Down" class="w-7 h-7 flex items-center justify-center text-slate-500 hover:text-blue-400 hover:bg-slate-700 disabled:opacity-20 transition border-r border-slate-700/50"><i class="fa-solid fa-angle-down text-xs"></i></button>
                            <button @click="moveBlockBottom(index)" :disabled="index === blocks.length - 1" title="Move to Bottom" class="w-7 h-7 flex items-center justify-center text-slate-500 hover:text-blue-400 hover:bg-slate-700 disabled:opacity-20 transition"><i class="fa-solid fa-angles-down text-[10px]"></i></button>
                        </div>

                        <!-- Type Selector -->
                        <select v-model="block.type" class="bg-transparent text-blue-300 text-xs font-bold py-1 px-2 uppercase tracking-wide cursor-pointer hover:text-blue-200 outline-none">
                            <option value="role">Role (Persona)</option>
                            <option value="context">Context (Data)</option>
                            <option value="task">Task (Instruction)</option>
                            <option value="code">Code Snippet</option>
                            <option value="constraints">Constraints</option>
                            <option value="text">Plain Text</option>
                        </select>
                    </div>

                    <!-- Preset Dropdown (Dynamic based on block type) -->
                    <div v-if="block.type === 'role'" class="flex-1 min-w-[200px]">
                        <select @change="(e) => block.content = e.target.value" class="w-full bg-slate-800 text-slate-400 text-[10px] py-1 px-2 rounded border border-slate-700/50 outline-none hover:border-emerald-500/50 transition cursor-pointer">
                            <option value="" disabled selected>âœ¨ Load Optimized Role Preset...</option>
                            <option v-for="(preset, pIndex) in presetRoles" :key="pIndex" :value="preset.content">{{ preset.name }}</option>
                        </select>
                    </div>
                    <div v-if="block.type === 'constraints'" class="flex-1 min-w-[200px]">
                        <select @change="(e) => block.content = e.target.value" class="w-full bg-slate-800 text-slate-400 text-[10px] py-1 px-2 rounded border border-slate-700/50 outline-none hover:border-red-500/50 transition cursor-pointer">
                            <option value="" disabled selected>ğŸ›¡ï¸ Load Hallucination Guard...</option>
                            <option v-for="(preset, pIndex) in presetConstraints" :key="pIndex" :value="preset.content">{{ preset.name }}</option>
                        </select>
                    </div>
                    
                    <div class="flex gap-2">
                        <!-- Translate Btn -->
                        <button @click="translateBlock(index)" :disabled="block.isTranslating" class="h-7 px-3 text-[10px] bg-indigo-500/10 text-indigo-300 border border-indigo-500/30 rounded hover:bg-indigo-500/20 transition flex items-center gap-2">
                            <i v-if="block.isTranslating" class="fa-solid fa-circle-notch fa-spin"></i>
                            <span v-else><i class="fa-solid fa-language"></i> EN</span>
                        </button>
                        <!-- Delete Btn -->
                        <button @click="removeBlock(index)" class="h-7 w-7 flex items-center justify-center text-red-400 hover:text-red-300 hover:bg-red-400/10 rounded transition">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>
                </div>

                <!-- Textarea -->
                <div class="p-1">
                    <textarea 
                        v-model="block.content" 
                        class="w-full bg-slate-900/30 text-slate-200 p-4 rounded-b-lg outline-none border-0 focus:ring-0 resize-none font-mono text-sm leading-relaxed placeholder-slate-600/50"
                        :placeholder="getPlaceholder(block.type)"></textarea>
                </div>
                
                <!-- Tag Indicator -->
                <div class="absolute bottom-3 right-4 text-[10px] text-slate-600 font-mono pointer-events-none select-none opacity-50">
                    {{ getWrapper(block.type)[0] }} ... {{ getWrapper(block.type)[1] }}
                </div>
            </div>
        </div>

        <!-- Add Buttons -->
        <div class="grid grid-cols-4 gap-3 mt-2">
            <button @click="addBlock('context')" class="bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-slate-200 py-3 rounded-xl text-xs font-bold border border-slate-700 transition flex flex-col items-center gap-1 group">
                <i class="fa-solid fa-database text-lg text-purple-500 group-hover:scale-110 transition"></i> CONTEXT
            </button>
            <button @click="addBlock('task')" class="bg-blue-900/20 hover:bg-blue-900/40 text-blue-400 hover:text-blue-300 py-3 rounded-xl text-xs font-bold border border-blue-800/50 transition flex flex-col items-center gap-1 group shadow-[0_0_15px_rgba(37,99,235,0.1)]">
                <i class="fa-solid fa-bullseye text-lg group-hover:scale-110 transition"></i> TASK
            </button>
            <button @click="addBlock('code')" class="bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-slate-200 py-3 rounded-xl text-xs font-bold border border-slate-700 transition flex flex-col items-center gap-1 group">
                <i class="fa-solid fa-code text-lg text-emerald-500 group-hover:scale-110 transition"></i> CODE
            </button>
             <button @click="addBlock('constraints')" class="bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-slate-200 py-3 rounded-xl text-xs font-bold border border-slate-700 transition flex flex-col items-center gap-1 group">
                <i class="fa-solid fa-shield-halved text-lg text-red-400 group-hover:scale-110 transition"></i> RULES
            </button>
        </div>
    </div>

    <!-- Right Column: Output & Strategy -->
    <div class="w-full lg:w-2/5 flex flex-col gap-5 sticky top-4 h-[calc(100vh-2rem)]">
        
        <!-- Strategy Panel -->
        <div class="glass rounded-xl p-5 border-t-4 border-t-blue-500">
            <h2 class="text-xs font-bold text-blue-400 uppercase mb-4 tracking-widest flex items-center gap-2">
                <i class="fa-solid fa-microchip"></i> Gemini 3 Strategy
            </h2>
            
            <div class="space-y-3">
                <label class="flex items-start gap-3 p-3 bg-slate-800/50 rounded-lg cursor-pointer hover:bg-slate-800 transition group border border-transparent hover:border-blue-500/30">
                    <div class="pt-0.5"><input type="checkbox" v-model="settings.useRepetition" class="w-4 h-4 rounded bg-slate-700 border-slate-600 text-blue-500 accent-blue-600"></div>
                    <div>
                        <div class="text-sm text-slate-200 font-bold group-hover:text-blue-300 transition">Prompt Repetition</div>
                        <div class="text-[11px] text-slate-500 leading-tight mt-1">
                            {{ t('repetitionDesc') }}
                            <a href="https://arxiv.org/pdf/2512.14982" target="_blank" class="block mt-1 text-blue-500/80 hover:text-blue-400"><i class="fa-solid fa-paperclip"></i> Paper: Leviathan et al., 2025</a>
                        </div>
                    </div>
                </label>

                <label class="flex items-start gap-3 p-3 bg-slate-800/50 rounded-lg cursor-pointer hover:bg-slate-800 transition group border border-transparent hover:border-pink-500/30">
                    <div class="pt-0.5"><input type="checkbox" v-model="settings.addCoT" class="w-4 h-4 rounded bg-slate-700 border-slate-600 text-pink-500 accent-pink-600"></div>
                    <div>
                        <div class="text-sm text-slate-200 font-bold group-hover:text-pink-300 transition">Chain of Thought (CoT)</div>
                        <div class="text-[11px] text-slate-500 leading-tight mt-1">
                            {{ t('cotDesc') }}
                            <a href="https://arxiv.org/abs/2205.11916" target="_blank" class="block mt-1 text-pink-500/80 hover:text-pink-400"><i class="fa-solid fa-paperclip"></i> Paper: Kojima et al., 2022</a>
                        </div>
                    </div>
                </label>
            </div>
        </div>

        <!-- Final Output -->
        <div class="glass rounded-xl p-0 flex-1 flex flex-col overflow-hidden border border-blue-500/20 shadow-2xl shadow-blue-900/10">
            <div class="bg-slate-900/80 p-3 flex justify-between items-center border-b border-slate-700/50 backdrop-blur-sm">
                <span class="text-[10px] font-mono font-bold text-slate-400 flex items-center gap-2">
                    <span class="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-pulse"></span> GENERATED PROMPT
                </span>
                
                <div class="flex items-center gap-1">
                    <!-- Scroll Buttons -->
                    <button @click="scrollToTop" :title="t('scrollTop')" class="h-6 w-6 flex items-center justify-center text-slate-500 hover:text-blue-400 hover:bg-slate-800 rounded transition">
                        <i class="fa-solid fa-arrow-up text-[10px]"></i>
                    </button>
                    <button @click="scrollToBottom" :title="t('scrollBottom')" class="h-6 w-6 flex items-center justify-center text-slate-500 hover:text-blue-400 hover:bg-slate-800 rounded transition">
                        <i class="fa-solid fa-arrow-down text-[10px]"></i>
                    </button>
                    
                    <!-- Divider -->
                    <div class="w-px h-4 bg-slate-700 mx-1"></div>

                    <!-- Save Buttons -->
                    <div class="flex bg-slate-800 rounded-lg border border-slate-700 overflow-hidden mr-2">
                        <button @click="downloadPrompt('txt')" :title="t('saveTxt')" class="px-2 py-1 text-[10px] text-slate-300 hover:text-white hover:bg-slate-700 transition font-bold">
                            <i class="fa-solid fa-floppy-disk mr-1"></i> TXT
                        </button>
                        <button @click="downloadPrompt('md')" :title="t('saveMd')" class="px-2 py-1 text-[10px] text-slate-400 hover:text-white hover:bg-slate-700 border-l border-slate-700 transition font-mono">
                            MD
                        </button>
                    </div>

                    <!-- Copy Button -->
                    <button 
                        @click="copyPrompt" 
                        class="text-xs text-white px-3 py-1.5 rounded-full transition shadow-lg shadow-blue-900/20 font-bold flex items-center gap-2"
                        :class="copied ? 'bg-emerald-500 hover:bg-emerald-600' : 'bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500'"
                    >
                        <i :class="copied ? 'fa-solid fa-check' : 'fa-regular fa-copy'"></i> 
                        {{ copied ? t('copied') : t('copyAll') }}
                    </button>
                </div>
            </div>
            
            <textarea ref="outputTextarea" readonly class="flex-1 w-full bg-[#080c14] text-slate-300 p-5 font-mono text-xs leading-loose outline-none resize-none selection:bg-blue-500/30" v-model="finalPrompt"></textarea>
            
            <div class="bg-slate-900 p-2 px-4 text-[10px] text-slate-600 border-t border-slate-800 flex justify-between">
                <span>Model: {{ selectedModel.split('/')[1] }}</span>
                <span>Length: {{ finalPrompt.length }} chars</span>
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, computed, onMounted } = Vue;

    // Translations Dictionary
    const translations = {
        en: {
            appSubtitle: 'Structured Prompt Optimizer (Gemini 3 Pro Optimized)',
            apiKeyPlaceholder: 'SiliconFlow API Key (sk-...)',
            saveKey: 'Save Key',
            modelGroupRec: 'âœ¨ General Intelligence (Recommended)',
            modelGroupTrans: 'ğŸ“š Translation Specialized',
            modelGroupFree: 'ğŸ†“ Other Models',
            repetitionDesc: 'Repeats the <task> block directly. Improves compliance for non-reasoning tasks. (Note: Redundant if CoT is active).',
            cotDesc: 'Appends Gemini-optimized reasoning instruction to the end of the prompt.',
            copyAll: 'COPY',
            copied: 'COPIED!',
            saveTxt: 'Save as .txt',
            saveMd: 'Save as .md',
            scrollTop: 'Scroll to Top',
            scrollBottom: 'Scroll to Bottom',
            ph_role: 'System Persona (e.g., You are Gemini 3, a strict coding architect...)',
            ph_context: 'Paste documents, data, or previous conversation here...',
            ph_task: 'The direct instruction (e.g., "Refactor this code")...',
            ph_code: 'Paste source code here...',
            ph_constraints: 'Negative constraints (e.g., "No external libraries")...',
            ph_default: 'Content...',
            alertKeySaved: 'API Key saved.',
            alertNoKey: 'Please save your API Key first.',
            alertTranslateFail: 'Translation failed: '
        },
        zh: {
            appSubtitle: 'çµæ§‹åŒ– Prompt å„ªåŒ–å™¨ (é‡å° Gemini 3 Pro å„ªåŒ–)',
            apiKeyPlaceholder: 'è²¼ä¸Š SiliconFlow API Key (sk-...)',
            saveKey: 'å„²å­˜',
            modelGroupRec: 'âœ¨ é€šç”¨æ™ºæ…§ (å¼·åŠ›æ¨è–¦)',
            modelGroupTrans: 'ğŸ“š ç¿»è­¯å°ˆç”¨',
            modelGroupFree: 'ğŸ†“ å…¶ä»–æ¨¡å‹',
            repetitionDesc: 'ç›´æ¥é‡è¤‡ <task> å€å¡Šã€‚æå‡éæ¨ç†ä»»å‹™çš„éµå¾ªåº¦ (è¨»ï¼šè‹¥å•Ÿç”¨ CoT å‰‡æ•ˆæœæœƒé‡ç–Š)ã€‚',
            cotDesc: 'åœ¨ Prompt å°¾ç«¯åŠ å…¥é‡å° Gemini å„ªåŒ–çš„æ¨ç†æŒ‡ä»¤ã€‚',
            copyAll: 'è¤‡è£½',
            copied: 'å·²è¤‡è£½ï¼',
            saveTxt: 'å„²å­˜ç‚º .txt',
            saveMd: 'å„²å­˜ç‚º .md',
            scrollTop: 'æ²å‹•è‡³é ‚éƒ¨',
            scrollBottom: 'æ²å‹•è‡³åº•éƒ¨',
            ph_role: 'è¨­å®šè§’è‰² (å¦‚ï¼šä½ æ˜¯ä¸€ä½åš´æ ¼çš„ Gemini 3 æ¶æ§‹å¸«...)',
            ph_context: 'è²¼ä¸ŠèƒŒæ™¯è³‡æ–™ã€æ–‡ä»¶æˆ–å°è©±ç´€éŒ„...',
            ph_task: 'æ˜ç¢ºçš„æŒ‡ä»¤ (å¦‚ï¼š"é‡æ§‹é€™æ®µç¨‹å¼ç¢¼")...',
            ph_code: 'è²¼ä¸ŠåŸå§‹ç¢¼...',
            ph_constraints: 'é™åˆ¶æ¢ä»¶ (å¦‚ï¼š"ä¸å¯ä½¿ç”¨å¤–éƒ¨å‡½å¼åº«")...',
            ph_default: 'è¼¸å…¥å…§å®¹...',
            alertKeySaved: 'API Key å·²å„²å­˜ã€‚',
            alertNoKey: 'è«‹å…ˆè¼¸å…¥ä¸¦å„²å­˜ API Keyã€‚',
            alertTranslateFail: 'ç¿»è­¯å¤±æ•—: '
        },
        ja: {
            appSubtitle: 'æ§‹é€ åŒ–ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæœ€é©åŒ– (Gemini 3 Pro æœ€é©åŒ–)',
            apiKeyPlaceholder: 'SiliconFlow API Key (sk-...)',
            saveKey: 'ä¿å­˜',
            modelGroupRec: 'âœ¨ æ¨å¥¨ (é«˜æ€§èƒ½)',
            modelGroupTrans: 'ğŸ“š ç¿»è¨³å°‚ç”¨',
            modelGroupFree: 'ğŸ†“ ãã®ä»–',
            repetitionDesc: '<task>ãƒ–ãƒ­ãƒƒã‚¯ã‚’ç¹°ã‚Šè¿”ã—ã¾ã™ã€‚æ¨è«–ä»¥å¤–ã®ã‚¿ã‚¹ã‚¯ã§é †å®ˆç‡ã‚’å‘ä¸Šã•ã›ã¾ã™ã€‚',
            cotDesc: 'Geminiç”¨ã«æœ€é©åŒ–ã•ã‚ŒãŸæ¨è«–æŒ‡ç¤ºã‚’ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æœ«å°¾ã«è¿½åŠ ã—ã¾ã™ã€‚',
            copyAll: 'ã‚³ãƒ”ãƒ¼',
            copied: 'å®Œäº†!',
            saveTxt: '.txt ã¨ã—ã¦ä¿å­˜',
            saveMd: '.md ã¨ã—ã¦ä¿å­˜',
            scrollTop: 'æœ€ä¸Šéƒ¨ã¸',
            scrollBottom: 'æœ€ä¸‹éƒ¨ã¸',
            ph_role: 'AIã®å½¹å‰²ã‚’å®šç¾© (Persona)...',
            ph_context: 'èƒŒæ™¯æƒ…å ±ã€ãƒ‡ãƒ¼ã‚¿ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’è²¼ã‚Šä»˜ã‘...',
            ph_task: 'ä¸»ãªã‚¿ã‚¹ã‚¯ã‚„æŒ‡ç¤ºã‚’è¨˜è¿°...',
            ph_code: 'ã‚³ãƒ¼ãƒ‰ã‚¹ãƒ‹ãƒšãƒƒãƒˆã‚’è²¼ã‚Šä»˜ã‘...',
            ph_constraints: 'åˆ¶ç´„äº‹é … (ä¾‹: å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªä½¿ç”¨ç¦æ­¢)...',
            ph_default: 'å†…å®¹ã‚’å…¥åŠ›...',
            alertKeySaved: 'APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚',
            alertNoKey: 'API Keyã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚',
            alertTranslateFail: 'ç¿»è¨³å¤±æ•—: '
        }
    };

    // Preset Data
    const presetRoles = [
        { 
            name: "Karpathy's Simulator (Multi-Expert Debate) [DEFAULT]", 
            content: "You are not an AI assistant. You are a high-fidelity simulator. Your task is to simulate a 'Board of Experts' appropriate for the user's query. Identify the most relevant expert personas (e.g., a skeptical academic, a pragmatic engineer, a visionary futurist) and simulate a rigorous debate or collaborative discussion among them to reach a comprehensive answer. Output the dialogue or the synthesized conclusion of this simulated group."
        },
        { 
            name: "Gemini 3 Pro - Coding Specialist", 
            content: "You are Gemini 3, a Distinguished Software Architect. You are precise, pragmatic, and heavily biased towards efficient, scalable, and modern coding practices.\n\n<instructions>\n1. Plan: Analyze the task and create a step-by-step plan before coding.\n2. Execute: Carry out the plan using modern syntax (e.g., Python 3.12+, ES2024).\n3. Validate: Review your output against the user's requirements.\n4. Format: Return a single, copy-pasteable code block.\n</instructions>"
        },
        {
            name: "Senior Technical Writer",
            content: "You are a Senior Technical Writer at a top-tier tech company (e.g., Google, Stripe). Your writing is clear, concise, and focused on user value. You avoid fluff, jargon without explanation, and passive voice. You prioritize structure, using bullet points and headers effectively."
        }
    ];

    const presetConstraints = [
        {
            name: "Strict Grounding (Reduce Hallucination) - Official",
            content: "You are a strictly grounded assistant limited to the information provided in the User Context. In your answers, rely **only** on the facts that are directly mentioned in that context. You must **not** access or utilize your own knowledge or common sense to answer. Do not assume or infer from the provided facts; simply report them exactly as they appear. If the exact answer is not explicitly written in the context, you must state that the information is not available."
        },
        {
            name: "Academic Verification & Citations",
            content: "Base your answer *only* on verifiable facts and scientific consensus. Where possible, cite credible English sources (e.g., academic papers, official documentation) to support your claims. If a statement is speculative, explicitly label it as such. Do not invent sources."
        },
        {
            name: "Concise & No Yapping",
            content: "Be extremely concise. Do not offer pleasantries (e.g., 'Here is the code', 'I hope this helps'). Output only the requested content/code. Minimize explanation unless explicitly asked."
        }
    ];

    createApp({
        setup() {
            const apiKey = ref('');
            const selectedModel = ref('Qwen/Qwen2.5-7B-Instruct');
            const currentLang = ref('en'); // Default: English
            const copied = ref(false); // New state for copy feedback
            const outputTextarea = ref(null); // Reference to the output textarea
            
            const blocks = ref([
                { type: 'role', content: presetRoles[0].content, isTranslating: false }, 
                { type: 'task', content: '', isTranslating: false }, // Reordered: Task is now 2nd
                { type: 'context', content: '', isTranslating: false } // Reordered: Context is now 3rd
            ]);

            // Changed Defaults: both true
            const settings = ref({
                useRepetition: true,
                addCoT: true
            });

            const t = (key) => translations[currentLang.value][key] || translations['en'][key];

            onMounted(() => {
                const savedKey = localStorage.getItem('siliconflow_key');
                const savedModel = localStorage.getItem('siliconflow_model');
                if (savedKey) apiKey.value = savedKey;
                if (savedModel) selectedModel.value = savedModel;
            });

            // --- Movement Logic ---
            const moveBlockUp = (i) => { if(i>0) [blocks.value[i], blocks.value[i-1]] = [blocks.value[i-1], blocks.value[i]]; };
            const moveBlockDown = (i) => { if(i<blocks.value.length-1) [blocks.value[i], blocks.value[i+1]] = [blocks.value[i+1], blocks.value[i]]; };
            const moveBlockTop = (i) => { if(i>0) blocks.value.unshift(blocks.value.splice(i, 1)[0]); };
            const moveBlockBottom = (i) => { if(i<blocks.value.length-1) blocks.value.push(blocks.value.splice(i, 1)[0]); };

            const saveKey = () => {
                localStorage.setItem('siliconflow_key', apiKey.value);
                localStorage.setItem('siliconflow_model', selectedModel.value);
                alert(t('alertKeySaved'));
            };

            const getWrapper = (type) => {
                const map = {
                    'text': ['', ''],
                    'role': ['<system_role>', '</system_role>'],
                    'context': ['<context>', '</context>'],
                    'task': ['<task>', '</task>'],
                    'code': ['<code_context>', '</code_context>'], 
                    'constraints': ['<constraints>', '</constraints>']
                };
                return map[type] || ['', ''];
            };

            const getPlaceholder = (type) => t('ph_' + type) || t('ph_default');

            const finalPrompt = computed(() => {
                let parts = [];
                
                // 1. Process standard blocks
                blocks.value.forEach(block => {
                    if (!block.content.trim()) return;
                    const [start, end] = getWrapper(block.type);
                    parts.push(`${start}\n${block.content.trim()}\n${end}`);
                });

                // 2. Prompt Repetition Logic
                if (settings.value.useRepetition) {
                    const taskBlocks = blocks.value.filter(b => b.type === 'task' && b.content.trim());
                    taskBlocks.forEach(block => {
                         parts.push(`<task>\n${block.content.trim()}\n</task>`);
                    });
                }

                // 3. Chain of Thought (CoT) Logic
                if (settings.value.addCoT) {
                    parts.push('\n<final_instruction>\nRemember to think step-by-step before answering.\n</final_instruction>');
                }

                return parts.join('\n\n');
            });

            const addBlock = (type) => blocks.value.push({ type, content: '', isTranslating: false });
            const removeBlock = (i) => blocks.value.splice(i, 1);
            
            const copyPrompt = () => {
                navigator.clipboard.writeText(finalPrompt.value);
                copied.value = true;
                setTimeout(() => { copied.value = false; }, 2000); 
            };

            // --- New Output Functions ---
            const scrollToTop = () => {
                if (outputTextarea.value) outputTextarea.value.scrollTop = 0;
            };

            const scrollToBottom = () => {
                if (outputTextarea.value) outputTextarea.value.scrollTop = outputTextarea.value.scrollHeight;
            };

            const downloadPrompt = (ext) => {
                const blob = new Blob([finalPrompt.value], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `gemini_prompt_${new Date().toISOString().slice(0,10)}.${ext}`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            const translateBlock = async (index) => {
                if (!apiKey.value) return alert(t('alertNoKey'));
                const block = blocks.value[index];
                if (!block.content) return;
                block.isTranslating = true;
                try {
                    const response = await fetch('https://api.siliconflow.cn/v1/chat/completions', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${apiKey.value}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            model: selectedModel.value,
                            messages: [
                                { role: "system", content: "Translate to English. Technical terms must remain accurate. Output ONLY the translated text." },
                                { role: "user", content: block.content }
                            ],
                            temperature: 0.3, max_tokens: 2048
                        })
                    });
                    const data = await response.json();
                    if (data.choices?.[0]) block.content = data.choices[0].message.content;
                } catch (e) { alert(t('alertTranslateFail') + e.message); } 
                finally { block.isTranslating = false; }
            };

            return {
                apiKey, saveKey, blocks, settings, finalPrompt, selectedModel, currentLang, copied, outputTextarea,
                addBlock, removeBlock, translateBlock, copyPrompt, scrollToTop, scrollToBottom, downloadPrompt,
                getWrapper, getPlaceholder, t,
                moveBlockUp, moveBlockDown, moveBlockTop, moveBlockBottom,
                presetRoles, presetConstraints // Export presets
            };
        }
    }).mount('#app');
</script>
</body>
</html>
